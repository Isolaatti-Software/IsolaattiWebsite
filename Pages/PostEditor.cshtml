@page "/EditorPro"
@model isolaatti_API.Pages.PostEditor

@{
    Layout = "Shared/_LayoutWebApp";
    ViewData["Title"] = "Editor Pro";
}

@section CSS
{
    <script>const pageTitle = "Editor Pro"</script>
}

<div id="vue-container" class="container-fluid">
<header class="col-12">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="m-3"><i class="fas fa-edit"></i> Editor Pro</h5>
        @if (Model.Edit)
        {
            <button class="btn btn-primary" v-on:click="post" v-bind:disabled="postButtonDisabled">
                <i class="fas fa-upload"></i> Guardar
            </button>
        }
        else
        {
            <button class="btn btn-primary" v-on:click="post" v-bind:disabled="postButtonDisabled">
                <i class="fas fa-upload"></i> Publicar
            </button>
        }
    </div>
</header>
<div class="container">
    <div class="row">
        <div class="col-md-12">

            <ul class="nav nav-tabs" id="post-editor-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="editing-tab" data-toggle="tab" href="#editing" role="tab" aria-controls="editing" aria-selected="true">Editar</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="preview-tab" data-toggle="tab" href="#preview" role="tab" aria-controls="preview" aria-selected="false">Vista previa</a>
                </li>

            </ul>
            <div class="tab-content" id="post-editor-tab-content">
                <div class="tab-pane fade show active" id="editing" role="tabpanel" aria-labelledby="editing-tab">
                    <div class="d-flex align-items-center">
                        <select class="custom-select m-2 w-100 custom-select-sm" v-model="privacy" title="Select privacy">
                            <option value="1">Privado</option>
                            <option value="2">Usuarios de Isolaatti</option>
                            <option value="3">Todos</option>
                        </select>
                        <button class="btn btn-secondary btn-sm ml-auto mr-1" title="Tema"
                                data-target="#theme-modal" data-toggle="modal">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm" title="Ayuda"
                                data-target="#help-modal" data-toggle="modal">
                            <i class="fas fa-question"></i>
                        </button>
                    </div>
                    <section id="post-editor-text-formatting-options" class="ml-2 mb-1 d-flex w-100">
                        <div class="btn-group btn-group-sm mr-1 overflow-auto">
                            <button class="btn btn-primary" v-on:click="insertHeading(1)">
                                <b>H1</b>
                            </button>
                            <button class="btn btn-primary" v-on:click="insertHeading(2)">
                                <b>H2</b>
                            </button>
                            <button class="btn btn-primary" v-on:click="insertHeading(3)">
                                <b>H3</b>
                            </button>
                            <button class="btn btn-primary" v-on:click="insertHeading(4)">
                                <b>H4</b>
                            </button>
                            <button class="btn btn-primary" v-on:click="insertHeading(5)">
                                <b>H5</b>
                            </button>
                            <button class="btn btn-primary" v-on:click="insertHeading(6)">
                                <b>H6</b>
                            </button>
                        </div>
                        <div class="btn-group btn-group-sm mr-1">
                            <button class="btn btn-primary" v-on:click="surroundTextWith('bold')">
                                <b>B</b>
                            </button>
                            <button class="btn btn-primary" v-on:click="surroundTextWith('italics')">
                                <em>I</em>
                            </button>
                        </div>
                        <button class="btn btn-primary btn-sm ml-auto" v-on:click="requestMicrophone()" data-target="#add-audio-modal" data-toggle="modal">
                            <i class="fas fa-microphone"></i> {{addAudioButtonText}}
                        </button>

                    </section>
                    <section id="editing-section" class="ml-2 mr-2 w-100">
                        <textarea id="raw-post-markdown" class="form-control" :value="input" 
                                            ref="markdownTextarea" v-bind:selection-start.prop="selectionStart" 
                                            v-bind:selection-end.prop="selectionEnd" v-on:input="update" ></textarea>
                    </section>
                </div>
                <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
                    <div id="editor-preview-side-panel">
                        <h5>Preview</h5>
                        <div class="d-flex mb-2 flex-column p-2 post"
                             :style="postThemeCSSStyle">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="user-name">
                                    <a href="#">@ViewData["name"]</a>
                                </span>
                            </div>
                            <div class="d-flex privacy-icon-container">
                                <div v-if="privacy === '1'">
                                    <i class="fas fa-user" title="Only you"></i><span class="sr-only">People on Isolaatti</span>
                                </div>
                                <div v-if="privacy === '2'">
                                    <i class="fas fa-user-friends" title="People on Isolaatti" aria-hidden="true"></i><span class="sr-only">People on Isolaatti</span>
                                </div>
                                <div v-if="privacy === '3'">
                                    <i class="fas fa-globe" title="All the world" aria-hidden="true"></i><span class="sr-only">Everyone</span>
                                </div>
                            </div>
                            <div class="mt-2 post-content" v-html="compiledMarkdown"></div>
                            <div class="d-flex justify-content-end">
                                <div class="btn-group">
                                    <button class="btn btn-dark btn-sm" type="button">
                                        <i class="fas fa-comments" aria-hidden="true"></i> 0
                                    </button>
                                    <button class="btn btn-dark btn-sm" type="button">
                                        <i class="fas fa-thumbs-up" aria-hidden="true"></i> 0
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="theme-modal">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-palette"></i> Tema
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="d-flex mb-2 flex-column p-2 post sticky-top" :style="postThemeCSSStyle">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="mt-2 post-content">
                            Así es como se ve tu tema.
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h5 class="card-header">Selecciona un tema predefinido</h5>
                    <div class="card-body">
                        <select class="custom-select" v-on:input="applyDefaultTheme">
                            <option v-for="(theme, index) in defaultThemes" :value="index">{{theme.name}}</option>
                        </select>
                    </div>
                </div>

                <div class="card mt-2">
                    <h5 class="card-header">
                        Personaliza el tema
                    </h5>
                    <div class="card-body">
                        <h5 class="card-title">Color de letra</h5>
                        <div class="form-group">
                            <input type="color" class="form-control form-control-sm"
                                   v-model="theme.fontColor">
                        </div>

                        <h5 class="card-title">Fondo</h5>
                        <div class="form-check mb-1">
                            <input class="form-check-input" type="checkbox" value="" id="isGradient" v-model="theme.gradient" true-value="true" false-value="false">
                            <label class="form-check-label" for="isGradient">
                                Gradiente
                            </label>
                        </div>
                        <div v-if="theme.gradient === 'true'">
                            <select class="custom-select" v-model="theme.background.type">
                                <option value="linear">Gradiente lineal</option>
                                <option value="radial">Gradiente radial</option>
                            </select>
                            <div v-if="theme.background.type==='linear'" class="mt-2">
                                <div class="form-group">
                                    <div class="input-group input-group-sm">
                                        <input type="number"
                                               v-model="theme.background.direction"
                                               class="form-control form-control-sm"/>
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">grados</span>
                                        </div>
                                    </div>
                                    <div class="d-flex mt-2" v-for="(color,index) in theme.background.colors">
                                        <input type="color"
                                               v-model="theme.background.colors[index]"
                                               class="form-control"/>
                                        <button type="button" class="btn btn-primary btn-sm ml-1" v-on:click="removeColor(index)" v-bind:disabled="theme.background.colors.length <= 2">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>

                                    <div class="d-flex w-100 justify-content-end">
                                        <button class="btn btn-primary btn-sm mt-1 ml-auto" v-on:click="addColor">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="mt-2">
                                <div class="form-group">
                                    <div class="d-flex mt-2" v-for="(color,index) in theme.background.colors">
                                        <input type="color"
                                               v-model="theme.background.colors[index]"
                                               class="form-control"/>
                                        <button type="button" class="btn btn-primary btn-sm ml-1" v-on:click="removeColor(index)" v-bind:disabled="theme.background.colors.length <= 2">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                    </div>

                                    <div class="d-flex w-100 justify-content-end">
                                        <button class="btn btn-primary btn-sm mt-1 ml-auto" v-on:click="addColor">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-else>
                            <div class="form-group">
                                <input type="color" class="form-control form-control-sm"
                                       v-model="theme.backgroundColor">
                            </div>
                        </div>

                        <h5 class="card-title">Borde</h5>
                        <div class="form-group">
                            <label>Color</label>
                            <input type="color" class="form-control form-control-sm"
                                   v-model="theme.border.color">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select class="custom-select custom-select-sm"
                                    v-model="theme.border.type">
                                <option value="none">Ninguno</option>
                                <option value="solid">Sólido</option>
                                <option value="dotted">Punteado</option>
                                <option value="dashed">Con guiones</option>
                                <option value="ridge">Cresta</option>
                                <option value="groove">Ranura</option>
                                <option value="inset">Recuadro hacia adentro</option>
                                <option value="outset">Recuadro hacia afuera</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tamaño</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control form-control-sm"
                                       v-model="theme.border.size"/>
                                <div class="input-group-prepend">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Radio (valor máximo recomendado 30px)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control form-control-sm"
                                       max="30" min="0"
                                       v-model="theme.border.radius">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-end">
                <span>Los cambios se reflejan automáticamente</span>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="add-audio-modal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-microphone"></i> Añade audio</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times</span>
                </button>
            </div>
            <div class="modal-body d-flex flex-column">
                <progress max="120" v-bind:value="audio.timeInSeconds" class="w-100"></progress>
                <span>{{audio.timeInSeconds}} segundos</span>
            </div>
            <div class="modal-footer d-flex flex-column">
                <div class="d-flex">
                    @* This group shows to allow user to start recording *@
                    <div class="btn-group" v-if="!audio.recording && !audio.recorded">
                        <button class="btn btn-danger" v-on:click="startRecording()" v-bind:disabled="audio.recorder.mediaStream == null">
                            Comenzar a grabar
                        </button>
                    </div>

                    @* This group is shown when an audio is being recorded*@
                    <div class="btn btn-group" v-if="audio.recording">
                        <button class="btn btn-primary" v-on:click="stopRecording()">
                            Detener
                        </button>
                    </div>

                    @* This group shows when an audio has been recorded *@
                    <div class="btn-group" v-if="audio.recorded">
                        <button class="btn btn-info" v-on:click="playRecord()">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-dark" v-on:click="resetRecording()">
                            Descartar
                        </button>
                        <button class="btn btn-primary" v-on:click="consolidate()">
                            Continuar
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="help-modal">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ayuda</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5>Privacidad</h5>
                <ul>
                    <li>Privado: solo tú puedes ver la publicación.</li>
                    <li>Usuarios de Isolaatti: todos los usuarios que tengan cuenta en Isolaatti pueden ver la publicación</li>
                    <li>Todos: todos pueden leer la publicación, incluso sin iniciar sesión.</li>
                </ul>
                <hr/>
                <h5>Publicaciones con audio</h5>
                <p>
                    Puedes grabar un audio de hasta 2 minutos y agregarlo a tu publicación. Para grabar un audio,
                    usa el <strong>Editor Pro</strong>
                </p>
                <hr/>
                <h5>Editor pro</h5>
                <p>
                    El Editor Pro es la mejor manera de escribir publicaciones largas (y cuando necesitas agregar
                    audios). En él cuentas con facilitadores de markdown y vista previa de la publicación
                </p>
                <hr/>
                <h5><i class="fab fa-markdown"></i> What is Markdown</h5>
                <p>Markdown es una sintáxis especial que permite formatear texto de menera sencilla.</p>
                <h5 class="mt-2">Básico</h5>
                <h6>Párrafos</h6>
                <p>
                    Separa cada párrafo con un salto de línea entre ellos, es decir, salta de linea dos veces al
                    terminar de escribir el párrafo.
                </p>
                <h6>Encabezados</h6>
                <p>Hay 6 niveles de encabezamiento. Son:</p>
                <code>
                    <pre>
    # Encabezado 1
    ## Encabezado 2
    ### Encabezado 3
    #### Encabezado 4
    ##### Encabezado 5
    ###### Encabezado 6
    </pre>
                </code>
                <p>Lo cual quedaría así</p>
                <h1>Encabezado 1</h1>
                <h2>Encabezado 2</h2>
                <h3>Encabezado 3</h3>
                <h4>Encabezado 4</h4>
                <h5>Encabezado 5</h5>
                <h6>Encabezado 6</h6>
                <hr/>

                <h6>Negritas e itálicas</h6>
                <p>Puedes colocar negristas y/o itálicas. Para hacerlo escribe:</p>
                <code>
                    <pre>
    **Esto está en negritas** *Esto está en itálicas* ***Esto está en negritas e itálicas***
    </pre>
                </code>
                <p>Lo cual quedaría así:</p>
                <p>
                    <b>Esto está en negritas</b> <i>Esto está en itálicas</i>
                    <b>
                        <i>Esto está en negritas e itálicas</i>
                    </b>
                </p>
                <hr/>

                <h6>Enlaces</h6>
                <p>Hay 3 maneras de definir enlaces.</p>
                <p>Si solo usarás en enlace solo una vez, puedes escribir:</p>
                <code>
                    <pre>
    [Visita Isolaatti](https://isolaatti.com/)
    </pre>
                </code>
                <p>Lo cual quedaría:</p>
                <p>
                    <a href="https://isolaatti.com/">Visita Isolaatti</a>
                </p>
                <hr/>

                <p>Pero si quieres utilizar un enlace más de una vez, puedes declararlo y utilizarlo así:</p>
                <code>
                    <pre>
    Atención, este es mi [sitio web]. Y sí, solo para confirmar, este es mi [sitio web]
    
    [sitio web]: https://erik-swdev.isolaatti.com/
    </pre>
                </code>
                <p>Lo cual quedaría así:</p>
                <p>
                    Atención, este es mi <a href="https://erik-swdev.isolaatti.com/">sitio web</a> . Y sí, solo para confirmar, este es mi <a href="https://erik-swdev.isolaatti.com/">sitio web</a>
                </p>
                <hr/>

                <p>Si solo quieres colocar el enlace tal cual, mostrando la URL completa, entonces escribe simplemente:</p>
                <code>
                    <pre>
    &lt;https://erik-swdev.isolaatti.com&gt;
    </pre>
                </code>
                <p>Lo cual quedaría simplemente:</p>
                <p>
                    <a href="https://erik-swdev.isolaatti.com">https://erik-swdev.isolaatti.com</a>
                </p>
                <hr/>

                <h5>Lee más acerca de Markdown</h5>
                <p>
                    Este texto no es todo, puedes hacer más cosas, como tablas, citas, colocar código, etc.
                    Para obtener más información, puedes leer <a href="https://www.markdownguide.org/basic-syntax/" target="_blank">esta guía</a> (sitio externo).
                </p>
            </div>
        </div>
    </div>
</div>
</div>


@section Scripts
{
    <script>
    const editExistingPost = "@Model.Edit" === "True";
    const editPostId = "@Model.EditPostId";
    </script>
    <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-storage.js"></script>
    <script>
    var firebaseConfig = {
        apiKey: "AIzaSyDZHVXLR_1imwVb2mCArnYpdbNx6XUPZBQ",
        authDomain: "isolaatti-b6641.firebaseapp.com",
        databaseURL: "https://isolaatti-b6641.firebaseio.com",
        projectId: "isolaatti-b6641",
        storageBucket: "isolaatti-b6641.appspot.com",
        messagingSenderId: "556033448926",
        appId: "1:556033448926:web:35759afc37d6a1585b1b4f",
        measurementId: "G-JQV4WX75RK"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var storage = firebase.storage();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="~/js/PostEditor.js"></script>
}