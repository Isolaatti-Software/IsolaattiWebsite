@page "/perfil/{id}"
@using isolaatti_API.Models
@using isolaatti_API.Utils
@model isolaatti_API.Pages.Profile

@{
    Layout = "Shared/_LayoutWebApp";
    ViewData["Title"] = ViewData["profile_name"];
}

@section CSS
{
    <script>const pageTitle = "@ViewData["profile_name"]"</script>
}

<!-- Modal followers -->
<div class="modal fade" id="modal-followers">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seguidores</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                <div class="profiles-list-container">
                    @if (!Model.Followers.Any())
                    {
                        <p class="m-3">
                            Esta cuenta no tiene seguidores. Puedes ser su primer seguidor.
                        </p>
                    }
                    @foreach (User user in Model.Followers)
                    {
                        <a class="user-profile-card"
                           asp-page="Profile" asp-route-id="@user.Id">
                            <img src='@UrlGenerators.GenerateProfilePictureUrl(user.Id, (string)ViewData["sessionToken"])'
                                 width="100" height="100" class="profile-pic mt-3"/>
                            <h6>@user.Name</h6>
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal following -->
<div class="modal fade" id="modal-following">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Siguiendo</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                <div class="profiles-list-container">
                    @if (!Model.Following.Any())
                    {
                        <p class="m-3">
                            Esta cuenta no sigue a nadie. Tal vez tú puedas ser la primera persona que siga.
                        </p>
                    }
                    @foreach (User user in Model.Following)
                    {
                        <a class="user-profile-card" asp-page="Profile" asp-route-id="@user.Id">
                            <img src='@UrlGenerators.GenerateProfilePictureUrl(user.Id, (string)ViewData["sessionToken"])'
                                 width="100" height="100" class="profile-pic mt-3"/>
                            <h6>@user.Name</h6>
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-lg-2 col-md-4 p-0">
    <header id="left-bar" class="p-2" style="background: linear-gradient(@Model.ProfileColor 5%, white)">
        <div class="d-flex justify-content-center align-items-center flex-column mt-3" id="profile_photo_container">
            <img src="@Model.ProfilePhotoUrl" width="100" height="100" class="profile-pic" id="profile_photo_el" ref="profilePictureElement"/>
            <button id="play-audio-description-btn" v-on:click="playAudioDescription" v-if="audioDescriptionUrl !== null" v-html="audioDescriptionButtonInnerText"></button>
            <div id="online-dot"></div>
        </div>
        <div class="translucent-white-card" style="margin-top: 30px;">
            <p class="text-center m-0 overflow-auto text-break username-profile">@ViewData["profile_name"]</p>
            @if ((bool)ViewData["showEmail"])
            {
                <p class="text-center m-0 overflow-auto text-break">
                    @ViewData["profile_email"]
                </p>
            }
            <p class="text-center text-break">@ViewData["description"]</p>
            <div class="d-flex mt-2 flex-column">
                <div class="btn-group btn-group-sm">
                    <a class="btn btn-link"
                       data-toggle="modal" href="#modal-followers">
                        Seguidores: <b>@ViewData["numberOfFollowers"]</b>
                    </a>
                    <a class="btn btn-link"
                       data-toggle="modal" href="#modal-following">
                        Siguiendo: <b>@ViewData["numberOfFollowing"]</b>
                    </a>
                </div>
                @if ((bool)ViewData["thisUserIsFollowingMe"])
                {
                    <span class="text-center mb-2 p-2 mr-1 badge badge-pill badge-success">
                        <i class="fas fa-user-friends"></i> Te sigue
                    </span>
                }
                <div class="card">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Likes
                            <span class="badge badge-primary badge-pill">@ViewData["numberOfLikes"]</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Publicaciones
                            <div class="badge badge-primary badge-pill">
                                @ViewData["numberOfPosts"]
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="d-flex mt-1">
                @if ((bool)ViewData["followingThisUser"])
                {
                    <button class="btn btn-primary btn-sm mb-2 w-100" id="followButton">Dejar de seguir <i class="fas fa-times"></i></button>
                }
                else
                {
                    <button class="btn btn-primary btn-sm mb-2 w-100" id="followButton">Seguir <i class="fas fa-check"></i></button>
                }
            </div>
            <div style="height: 10px"></div>
        </div>
    </header>
</div>
<div class="col-lg-10 col-md-6">
    <section class="mt-3 d-flex flex-column" id="your-posts-deposit">
        <h5 class="m-3 text-center"><i class="far fa-newspaper"></i> Discusiones de @ViewData["profile_name"]</h5>
        <section id="vue-container" class="d-flex flex-column pt-1 mt-2 mb-3 align-items-center">
            <h5 class="m-2 text-center" v-if="posts.length === 0">@ViewData["profile_name"] no tiene ninguna publicación</h5>
            <post-template v-for="post in posts" :post="post.postData"
                           v-bind:theme="post.theme"
                           v-bind:preview="false"
                           v-on:like="likePost(post.postData)"
                           v-on:un-like="unLikePost(post.postData)"
                           v-model="postLinkToShare"
                           v-on:delete="deletePost(post.postData.id)"
                           v-on:play-audio="playAudio(post.postData.audioUrl)"
                           :audio-url="audioUrl"
                           :paused="paused"
                           :is-modal="false"
                           v-on:view-thread="viewComments(post.postData)"
                           v-bind:key="post.postData.id">
            </post-template>
            <div v-if="loading" class="d-flex justify-content-center mt-2">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Cargando más contenido...</span>
                </div>
            </div>
            <div v-if="moreContent" class="d-flex flex-column align-items-center mt-2">
                <button class="btn btn-primary" v-on:click="fetchPosts(lastId)">Cargar más</button>
            </div>
            <div class="modal fade" id="modal-share-post">
                <div class="modal-dialog-centered modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                Compartir publicación
                            </h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>
                                Usa este enlace para compartir la publicación
                            </p>
                            <button class="btn btn-primary" v-on:click="copyToClipboard(postLinkToShare)">Copiar al portapapeles</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="thread-viewer">
                <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Comentarios</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <h5 v-if="commentsViewer.comments.length===0" class="m-4 text-center"><i class="fas fa-sad-tear"></i> No hay comentarios que mostrar</h5>
                            <comment v-for="comment in commentsViewer.comments"
                                     :comment="comment"
                                     :audio-url="audioUrl"
                                     :paused="paused"
                                     v-on:delete-comment="deleteComment(comment.id)"
                                     v-on:play-audio="playAudio(comment.audioUrl)">
                            </comment>
                        </div>
                        <div class="modal-footer">
                            <span>
                                <a :href="openThreadLink">Abrir discusión</a>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </section>

</div>

@section Scripts
{
    <script>
    document.querySelector('#isolaatti-top-bar').style.backgroundColor = '@Model.ProfileColor';
    let thisProfileId = "@ViewData["profile_id"]";
    let thisUserIsFollowingMe = "@ViewData["thisUserIsFollowingMe"]" === "True";
    let followingThisUser = "@ViewData["followingThisUser"]" === "True";
    </script>
    @if (ViewData["audioDescription"] == null)
    {
        <script>const audioDescriptionUrl = null;</script>
    }
    else
    {
        <script>const audioDescriptionUrl = "@ViewData["audioDescription"]";</script>
    }
    <script>
    let accountData = {
        userId: @ViewData["profile_id"]
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="~/js/lib/purify.min.js"></script>
    <script src="~/js/VueComponents/postComponent.js"></script>
    <script src="~/js/VueComponents/commentComponent.js"></script>
    <script src="~/js/profile.js"></script>
}
